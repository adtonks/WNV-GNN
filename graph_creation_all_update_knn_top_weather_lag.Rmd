---
title: "Data to graph"
author: "Adam Tonks"
date: "10/8/2021"
output: pdf_document
---

```{r}
data <- read.csv("csv_files/all_flat.csv")

data$COLLECDATEFORMAT <- as.Date(data$COLLECDATE, format="%m/%d/%y")
data$RESULTTYPE <- trimws(data$RESULTTYPE)
data$MIR <- (data$RESULTTYPE=="POSITIVE") / data$POOLSIZE
data$LATLONG <- paste(data$LATITUDE, data$LONGITUDE, sep=", ")
data$TRAPID <- as.integer(as.factor(data$LATLONG))-1
# note days not always consecutive
data$DAY <- as.integer(as.factor(data$COLLECDATEFORMAT))
data$MONTH <- as.numeric(strftime(data$COLLECDATEFORMAT, "%m"))

data$NEXTWKPOS <- rep(0, nrow(data))
data$WEEK_POS_0 <- rep(0, nrow(data))
data$WEEK_POS_7 <- rep(0, nrow(data))
data$WEEK_POS_14 <- rep(0, nrow(data))
data$WEEK_POS_21 <- rep(0, nrow(data))
data$WEEK_POS_28 <- rep(0, nrow(data))
data$WEEK_POS_35 <- rep(0, nrow(data))
data$WEEK_POS_42 <- rep(0, nrow(data))

data <- data[c("DAY", "COLLECDATEFORMAT", "MONTH", "LATITUDE", "LONGITUDE", "RESULTTYPE", "POOLSIZE", "NEXTWKPOS", "WEEK_POS_0", "WEEK_POS_7", "WEEK_POS_14", "WEEK_POS_21", "WEEK_POS_28", "WEEK_POS_35", "WEEK_POS_42", "TRAPID", "MIR")]
data <- data[!duplicated(data[c("TRAPID", "COLLECDATEFORMAT")]), ]
```

```{r}
top_traps <- order(table(data$TRAPID), decreasing=TRUE)[1:floor(0.1*length(unique(data$TRAPID)))]-1
data <- data[data$TRAPID %in% top_traps, ]
```

```{r}
# w_data <- read.csv("csv_files/ohare_weather_dev.csv")
# w_data$Date <- as.Date(as.character(w_data$Date), format="%Y-%m-%d")
# w_data <- reshape(w_data, idvar="Date", timevar="Attribute", direction="wide")
# w_data <- w_data[, 1:6]
# names(w_data) <- c("COLLECDATEFORMAT", "TMAX", "TMIN", "PRCP", "SNOW", "SNWD")

w_data <- read.csv("csv_files/ohare_summary_comp_NA_0.csv")
w_data$COLLECDATEFORMAT <- as.Date(w_data$COLLECDATEFORMAT, format="%Y-%m-%d")

lag_vect <- c(7, 14, 21, 28, 35, 42)
lag_w_data <- w_data
for(lag in lag_vect) {
  lag_w_data_temp <- w_data
  lag_w_data_temp["COLLECDATEFORMAT"] <- lag_w_data_temp["COLLECDATEFORMAT"]+lag
  lag_w_data <- merge(lag_w_data, lag_w_data_temp, by="COLLECDATEFORMAT", suffixes=c("", lag))
}
```

```{r}
data <- merge(data, lag_w_data, by="COLLECDATEFORMAT")
```

```{r}
dates <- unique(data$COLLECDATEFORMAT)
day_data_comp <- NULL
date_len <- length(dates)

for(n in seq_len(date_len)) {
  if((n%%500==0)||(n==date_len)) {
    print(sprintf("%d of %d", n, date_len))
    flush.console()
  }
  date <- dates[n]
  day_data <- data[data$COLLECDATEFORMAT==date, ]
  week_plus_7 <- data[(data$COLLECDATEFORMAT>=date+as.difftime(7,  units="days")) &
      (data$COLLECDATEFORMAT<=date+as.difftime(13,  units="days")), ]
  week_0 <- data[(data$COLLECDATEFORMAT>=date-as.difftime(6,  units="days")) &
      (data$COLLECDATEFORMAT<=date), ]
  week_7 <- data[(data$COLLECDATEFORMAT>=date-as.difftime(13,  units="days")) &
      (data$COLLECDATEFORMAT<=date-as.difftime(7,  units="days")), ]
  week_14 <- data[(data$COLLECDATEFORMAT>=date-as.difftime(20,  units="days")) &
      (data$COLLECDATEFORMAT<=date-as.difftime(14,  units="days")), ]
  week_21 <- data[(data$COLLECDATEFORMAT>=date-as.difftime(27,  units="days")) &
      (data$COLLECDATEFORMAT<=date-as.difftime(21,  units="days")), ]
  week_28 <- data[(data$COLLECDATEFORMAT>=date-as.difftime(34,  units="days")) &
      (data$COLLECDATEFORMAT<=date-as.difftime(28,  units="days")), ]
  week_35 <- data[(data$COLLECDATEFORMAT>=date-as.difftime(41,  units="days")) &
      (data$COLLECDATEFORMAT<=date-as.difftime(35,  units="days")), ]
  week_42 <- data[(data$COLLECDATEFORMAT>=date-as.difftime(48,  units="days")) &
      (data$COLLECDATEFORMAT<=date-as.difftime(42,  units="days")), ]
  
  for(trap in day_data$TRAPID) {
    day_data$NEXTWKPOS[day_data$TRAPID==trap] <- as.numeric(sum(week_plus_7$RESULTTYPE[week_plus_7$TRAPID==trap]=="POSITIVE")>0)
    day_data$WEEK_POS_0[day_data$TRAPID==trap] <- as.numeric(sum(week_0$RESULTTYPE[week_0$TRAPID==trap]=="POSITIVE")>0)
    day_data$WEEK_POS_7[day_data$TRAPID==trap] <- as.numeric(sum(week_7$RESULTTYPE[week_7$TRAPID==trap]=="POSITIVE")>0)
    day_data$WEEK_POS_14[day_data$TRAPID==trap] <- as.numeric(sum(week_14$RESULTTYPE[week_14$TRAPID==trap]=="POSITIVE")>0)
    day_data$WEEK_POS_21[day_data$TRAPID==trap] <- as.numeric(sum(week_21$RESULTTYPE[week_21$TRAPID==trap]=="POSITIVE")>0)
    day_data$WEEK_POS_28[day_data$TRAPID==trap] <- as.numeric(sum(week_28$RESULTTYPE[week_28$TRAPID==trap]=="POSITIVE")>0)
    day_data$WEEK_POS_35[day_data$TRAPID==trap] <- as.numeric(sum(week_35$RESULTTYPE[week_35$TRAPID==trap]=="POSITIVE")>0)
    day_data$WEEK_POS_42[day_data$TRAPID==trap] <- as.numeric(sum(week_42$RESULTTYPE[week_42$TRAPID==trap]=="POSITIVE")>0)
  }
  day_data_comp <- rbind.data.frame(day_data_comp, day_data)
}

data <- day_data_comp
```

```{r}
# neighbors per node
k <- 5
day_data_comp <- NULL

for(n in seq_len(date_len)) {
  if((n%%500==0)||(n==date_len)) {
    print(sprintf("%d of %d", n, date_len))
    flush.console()
  }
  date <- dates[n]
  day_data <- data[data$COLLECDATEFORMAT==date, ]
  edge_list <- rep("", nrow(day_data))
  dist_list <- rep("", nrow(day_data))
  nodelabels <- seq(nrow(day_data))-1
  for(i in nodelabels) {
    other_node_pos <- day_data[nodelabels[nodelabels!=i]+1, c("LATITUDE", "LONGITUDE")]
    other_node_pos$DIST <- (other_node_pos$LATITUDE-day_data[i+1, "LATITUDE"])^2 +
      (other_node_pos$LONGITUDE-day_data[i+1, "LONGITUDE"])^2
    other_node_pos$RANK <- rank(other_node_pos$DIST, ties.method = 'random')
    neighbors <- nodelabels[nodelabels!=i][other_node_pos$RANK<=k]
    neighbors_dists <- format(other_node_pos$DIST[other_node_pos$RANK<=k], digits=5, trim=TRUE)
    edge_list[i+1] <- paste(neighbors, collapse=", ")
    dist_list[i+1] <- paste(neighbors_dists, collapse=", ")
  }
  day_data$NODELABEL <- nodelabels
  day_data$EDGES <- edge_list
  day_data$DISTS <- dist_list
  day_data_comp <- rbind.data.frame(day_data_comp, day_data)
}

data <- day_data_comp
```

```{r}
data$DailyPrecipitation <- as.numeric(data$DailyPrecipitation)
data$DailyPrecipitation[is.na(data$DailyPrecipitation)] <- 0
data$DailyPrecipitation7 <- as.numeric(data$DailyPrecipitation7)
data$DailyPrecipitation7[is.na(data$DailyPrecipitation7)] <- 0
data$DailyPrecipitation14 <- as.numeric(data$DailyPrecipitation14)
data$DailyPrecipitation14[is.na(data$DailyPrecipitation14)] <- 0
data$DailyPrecipitation21 <- as.numeric(data$DailyPrecipitation21)
data$DailyPrecipitation21[is.na(data$DailyPrecipitation21)] <- 0
data$DailyPrecipitation28 <- as.numeric(data$DailyPrecipitation28)
data$DailyPrecipitation28[is.na(data$DailyPrecipitation28)] <- 0
data$DailyPrecipitation35 <- as.numeric(data$DailyPrecipitation35)
data$DailyPrecipitation35[is.na(data$DailyPrecipitation35)] <- 0
data$DailyPrecipitation42 <- as.numeric(data$DailyPrecipitation42)
data$DailyPrecipitation42[is.na(data$DailyPrecipitation42)] <- 0
write.csv(data, "csv_files/all_graph_update_lag_weather_nn_top_weather_lag_dev_4.csv", row.names=FALSE)
```

```{r}
table_dat <- table(data$COLLECDATEFORMAT)
order_dat <- order(names(table_dat))
plot(table_dat[order_dat], type="l", ylab="No. of traps")
hist(table(data$COLLECDATEFORMAT))
means <- NULL
years <- 2008:2020
for(year in years) {
  means <- c(means, mean(table(data$COLLECDATEFORMAT[format(data$COLLECDATEFORMAT, "%Y")==year])))
}
plot(years, means, type="l")
```